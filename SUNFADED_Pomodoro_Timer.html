<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SUNFADED // POMODORO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@100;300;600;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --glass-bg: rgba(30, 41, 59, 0.7);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-main: #E2E8F0;
            --text-muted: #94A3B8;
            --accent-fade: #99f6e4; /* Muted Teal */
        }

        body {
            font-family: 'Montserrat', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #0f172a;
            color: var(--text-main);
            overflow: hidden; /* Prevent scrolling */
        }

        /* Cinematic Background Effect */
        .bg-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
            background-image: url('https://images.unsplash.com/photo-1470163395405-d2b80e7450ed?q=80&w=2070&auto=format&fit=crop'); 
            background-size: cover;
            background-position: center;
            filter: grayscale(80%) contrast(90%) brightness(60%);
            transition: transform 20s ease-in-out;
        }

        .bg-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: linear-gradient(to bottom, rgba(15, 23, 42, 0.4), rgba(15, 23, 42, 0.9));
            backdrop-filter: blur(8px);
        }

        /* Grain Effect */
        .grain {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
            opacity: 0.05;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
        }

        /* Typography & Inputs */
        .title-text {
            letter-spacing: 0.3em;
            text-shadow: 0 0 20px rgba(255,255,255,0.2);
        }

        .timer-display {
            font-variant-numeric: tabular-nums;
            text-shadow: 0 0 30px rgba(153, 246, 228, 0.1);
        }

        input[type="number"] {
            background: transparent;
            border-bottom: 1px solid var(--text-muted);
            color: var(--text-main);
            text-align: center;
            font-family: 'Montserrat', sans-serif;
            appearance: none;
            -moz-appearance: textfield;
        }
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"]:focus {
            outline: none;
            border-bottom: 1px solid var(--accent-fade);
        }

        /* Custom Range Slider */
        .glass-panel {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .btn-control {
            transition: all 0.3s ease;
        }
        .btn-control:hover {
            letter-spacing: 0.2em;
            color: var(--accent-fade);
        }

        .btn-adjust {
            color: var(--text-muted);
            transition: color 0.2s;
            cursor: pointer;
            padding: 0 0.5rem;
            font-size: 1.25rem;
            user-select: none;
        }
        .btn-adjust:hover {
            color: var(--accent-fade);
        }
        
        /* Animations */
        @keyframes pulse-slow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .animate-breathe {
            animation: pulse-slow 4s infinite ease-in-out;
        }

        .progress-ring {
            transition: stroke-dashoffset 1s linear;
        }
    </style>
</head>
<body class="h-screen flex items-center justify-center relative">

    <!-- Background Elements -->
    <div class="bg-layer" id="bgLayer"></div>
    <div class="bg-overlay"></div>
    <div class="grain"></div>

    <!-- Main Container -->
    <main class="relative z-10 w-full max-w-lg p-6 mx-auto flex flex-col items-center justify-between h-[90vh]">
        
        <!-- Header -->
        <header class="text-center w-full animate-breathe">
            <h1 class="text-4xl md:text-6xl font-black uppercase text-white title-text mb-2">Sunfaded</h1>
            <div class="h-[1px] w-full bg-gradient-to-r from-transparent via-gray-500 to-transparent"></div>
            <p id="statusText" class="text-xs md:text-sm tracking-[0.5em] text-teal-200 mt-2 uppercase opacity-80">System Ready</p>
        </header>

        <!-- Timer Display Section -->
        <div class="relative flex flex-col items-center justify-center py-10">
            <!-- SVG Progress Circle -->
            <!-- Using pathLength="1" allows us to use 0-1 range for dashoffset regardless of pixel size -->
            <svg class="absolute w-[300px] h-[300px] md:w-[380px] md:h-[380px] -rotate-90 pointer-events-none transform">
                <circle cx="50%" cy="50%" r="48%" stroke="rgba(255,255,255,0.05)" stroke-width="2" fill="transparent" />
                <circle id="progressRing" cx="50%" cy="50%" r="48%" stroke="#99f6e4" stroke-width="2" fill="transparent" 
                        pathLength="1" stroke-dasharray="1" stroke-dashoffset="0" stroke-linecap="round"
                        class="progress-ring opacity-50" />
            </svg>

            <!-- Digital Time -->
            <div class="text-center z-20">
                <div id="timer" class="text-7xl md:text-9xl font-thin tracking-tighter text-white timer-display">25:00</div>
                <div class="mt-4 flex justify-center gap-2 items-center text-gray-400 text-xs tracking-widest uppercase">
                    <span>Loop</span>
                    <span id="loopDisplay" class="text-white font-bold">1 / 4</span>
                </div>
            </div>
        </div>

        <!-- Controls & Settings -->
        <div class="w-full space-y-8">
            
            <!-- Playback Controls -->
            <div class="flex justify-center gap-12 items-center">
                <button onclick="resetTimer()" class="btn-control text-xs uppercase tracking-widest text-gray-400 hover:text-white">
                    Reset
                </button>
                <button id="mainBtn" onclick="toggleTimer()" class="btn-control text-xl uppercase tracking-[0.3em] font-bold text-white border border-white/20 px-8 py-3 bg-white/5 hover:bg-white/10 backdrop-blur-sm">
                    Start
                </button>
                <button onclick="skipPhase()" class="btn-control text-xs uppercase tracking-widest text-gray-400 hover:text-white">
                    Skip
                </button>
            </div>

            <!-- Settings Panel -->
            <div class="glass-panel p-6 rounded-none w-full mt-8">
                <div class="flex justify-between items-end gap-2 md:gap-4 text-center">
                    
                    <!-- Work Setting -->
                    <div class="flex flex-col items-center">
                        <label class="text-[10px] uppercase tracking-widest text-gray-500 mb-2">Work (Min)</label>
                        <div class="flex items-center justify-center">
                            <span class="btn-adjust" onclick="adjustValue('workInput', -1)">-</span>
                            <input type="number" id="workInput" value="25" min="1" max="60" class="w-12 text-xl bg-transparent border-b border-gray-600 pb-1 focus:border-teal-300 transition-colors" onchange="updateSettings()">
                            <span class="btn-adjust" onclick="adjustValue('workInput', 1)">+</span>
                        </div>
                    </div>
                    
                    <div class="h-8 w-[1px] bg-gray-700"></div>

                    <!-- Rest Setting -->
                    <div class="flex flex-col items-center">
                        <label class="text-[10px] uppercase tracking-widest text-gray-500 mb-2">Rest (Min)</label>
                        <div class="flex items-center justify-center">
                            <span class="btn-adjust" onclick="adjustValue('restInput', -1)">-</span>
                            <input type="number" id="restInput" value="5" min="1" max="30" class="w-12 text-xl bg-transparent border-b border-gray-600 pb-1 focus:border-teal-300 transition-colors" onchange="updateSettings()">
                            <span class="btn-adjust" onclick="adjustValue('restInput', 1)">+</span>
                        </div>
                    </div>

                    <div class="h-8 w-[1px] bg-gray-700"></div>

                    <!-- Loops Setting -->
                    <div class="flex flex-col items-center">
                        <label class="text-[10px] uppercase tracking-widest text-gray-500 mb-2">Loops</label>
                        <div class="flex items-center justify-center">
                            <span class="btn-adjust" onclick="adjustValue('loopsInput', -1)">-</span>
                            <input type="number" id="loopsInput" value="4" min="1" max="12" class="w-12 text-xl bg-transparent border-b border-gray-600 pb-1 focus:border-teal-300 transition-colors" onchange="updateSettings()">
                            <span class="btn-adjust" onclick="adjustValue('loopsInput', 1)">+</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Audio Logic & Timer Logic -->
    <script>
        // State
        let workTime = 25 * 60;
        let restTime = 5 * 60;
        let totalLoops = 4;
        let currentLoop = 1;
        let isWorkMode = true;
        let isRunning = false;
        let timeLeft = workTime;
        let timerId = null;
        let totalTimeForProgress = workTime;

        // DOM Elements
        const timerDisplay = document.getElementById('timer');
        const statusText = document.getElementById('statusText');
        const mainBtn = document.getElementById('mainBtn');
        const workInput = document.getElementById('workInput');
        const restInput = document.getElementById('restInput');
        const loopsInput = document.getElementById('loopsInput');
        const loopDisplay = document.getElementById('loopDisplay');
        const progressRing = document.getElementById('progressRing');
        const bgLayer = document.getElementById('bgLayer');

        // Circle Progress Setup
        // Using pathLength="1" allows us to work with 0 to 1 values directly.
        // 0 = Full circle (if we count backwards) or Empty depending on dashoffset logic.
        // Logic: dasharray=1. 
        // offset=0 -> Full Stroke.
        // offset=1 -> No Stroke.
        const circleCircumference = 1; 

        function init() {
            updateSettings();
            render();
        }

        function adjustValue(inputId, change) {
            const input = document.getElementById(inputId);
            let val = parseInt(input.value);
            let min = parseInt(input.min);
            let max = parseInt(input.max);
            
            val += change;
            
            if (val >= min && val <= max) {
                input.value = val;
                updateSettings();
            }
        }

        function updateSettings() {
            // Only allow updates if timer is not running
            if (!isRunning) {
                workTime = parseInt(workInput.value) * 60;
                restTime = parseInt(restInput.value) * 60;
                totalLoops = parseInt(loopsInput.value);
                
                // Reset state to start
                resetTimer();
            }
        }

        function toggleTimer() {
            if (isRunning) {
                pauseTimer();
            } else {
                startTimer();
            }
        }

        function startTimer() {
            if (isRunning) return;
            isRunning = true;
            mainBtn.innerText = "Pause";
            mainBtn.classList.add('border-teal-400', 'text-teal-200');
            mainBtn.classList.remove('border-white/20');
            
            // Audio Context needs user interaction to start
            resumeAudioContext();

            timerId = setInterval(() => {
                if (timeLeft > 0) {
                    timeLeft--;
                    render();
                } else {
                    handleTimerComplete();
                }
            }, 1000);
        }

        function pauseTimer() {
            isRunning = false;
            clearInterval(timerId);
            mainBtn.innerText = "Resume";
            mainBtn.classList.remove('border-teal-400', 'text-teal-200');
            mainBtn.classList.add('border-white/20');
            render();
        }

        function resetTimer() {
            pauseTimer();
            mainBtn.innerText = "Start";
            isWorkMode = true;
            currentLoop = 1;
            timeLeft = parseInt(workInput.value) * 60;
            totalTimeForProgress = timeLeft;
            updateStatusText();
            render();
        }

        function skipPhase() {
            pauseTimer();
            handleTimerComplete();
        }

        function handleTimerComplete() {
            playAlarm();
            
            if (isWorkMode) {
                // Work session ended
                if (currentLoop < totalLoops) {
                    isWorkMode = false;
                    timeLeft = restTime;
                    totalTimeForProgress = restTime;
                    startTimer(); 
                } else {
                    // All loops done
                    finishAll();
                    return;
                }
            } else {
                // Rest session ended
                isWorkMode = true;
                currentLoop++;
                timeLeft = workTime;
                totalTimeForProgress = workTime;
                startTimer();
            }
            updateStatusText();
            render();
        }

        function finishAll() {
            pauseTimer();
            mainBtn.innerText = "Restart";
            statusText.innerText = "Sequence Complete";
            statusText.style.color = "#fff";
            timeLeft = 0;
            render();
            // Reset logic for next click
            currentLoop = totalLoops; 
            // Setting isRunning false handled by pauseTimer
        }

        function updateStatusText() {
            if (isWorkMode) {
                statusText.innerText = "/// Focus Sequence Active ///";
                statusText.className = "text-xs md:text-sm tracking-[0.5em] text-teal-200 mt-2 uppercase opacity-80";
                bgLayer.style.transform = "scale(1.05)";
                progressRing.style.stroke = "#99f6e4"; // Teal
            } else {
                statusText.innerText = "... Rest Mode ...";
                statusText.className = "text-xs md:text-sm tracking-[0.5em] text-blue-200 mt-2 uppercase opacity-60";
                bgLayer.style.transform = "scale(1)";
                progressRing.style.stroke = "#94a3b8"; // Gray
            }
        }

        function render() {
            // Time Formatting
            const m = Math.floor(timeLeft / 60);
            const s = timeLeft % 60;
            timerDisplay.innerText = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            
            // Loop Display
            loopDisplay.innerText = `${currentLoop} / ${totalLoops}`;

            // Progress Ring
            // logic: dasharray=1. 
            // We want circle to shrink.
            // progress 1.0 = full (offset 0)
            // progress 0.0 = empty (offset 1)
            const progress = timeLeft / totalTimeForProgress;
            const offset = 1 - progress; // Simple 0 to 1 inversion
            progressRing.style.strokeDashoffset = offset;
            
            // Tab title update
            document.title = `(${m}:${s.toString().padStart(2, '0')}) Sunfaded`;
        }

        // --- Audio System (Web Audio API) ---
        let audioCtx;

        function resumeAudioContext() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }

        function playAlarm() {
            resumeAudioContext();
            
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            // Ethereal chord alert
            const now = audioCtx.currentTime;
            
            // Fundamental Tone
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(440, now); // A4
            oscillator.frequency.exponentialRampToValueAtTime(880, now + 0.1); // Slide up to A5
            
            // Envelope
            gainNode.gain.setValueAtTime(0, now);
            gainNode.gain.linearRampToValueAtTime(0.3, now + 0.1);
            gainNode.gain.exponentialRampToValueAtTime(0.001, now + 2);

            oscillator.start(now);
            oscillator.stop(now + 2);

            // Second layer for "dreamy" feel
            const osc2 = audioCtx.createOscillator();
            const gain2 = audioCtx.createGain();
            osc2.connect(gain2);
            gain2.connect(audioCtx.destination);
            
            osc2.type = 'triangle';
            osc2.frequency.setValueAtTime(554.37, now); // C#5
            
            gain2.gain.setValueAtTime(0, now);
            gain2.gain.linearRampToValueAtTime(0.1, now + 0.2);
            gain2.gain.exponentialRampToValueAtTime(0.001, now + 3);
            
            osc2.start(now);
            osc2.stop(now + 3);
        }

        // Initialize
        init();

    </script>
</body>
</html>
